name: Dev Deploy

on:
  # Runs on pushes to all branches except main
  push:
    branches:
      - "*" # matches every branch that doesn't contain a '/'
      - "*/*" # matches every branch containing a single '/'
      - "**" # matches every branch
      - "!main" # excludes main
# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout staging
        uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
      - name: get-npm-version
        id: package-version
        uses: martinbeentjes/npm-get-version-action@v1.3.1
      - name: Get current unix timestamp
        id: timestamp
        uses: release-kit/unix-timestamp@v1
      - run: npm ci
      - run: npm run build --if-present
      - name: Build image
        run: docker build -t ghcr.io/esa-earthcode/portal:v${{ steps.package-version.outputs.current-version}}-${{ github.head_ref || github.ref_name }}.${{ steps.timestamp.outputs.timestamp }} .
      - name: Login ghcr
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $ --password-stdin
      - name: Push ghcr
        run: docker push ghcr.io/esa-earthcode/portal:v${{ steps.package-version.outputs.current-version}}-${{ github.head_ref || github.ref_name }}.${{ steps.timestamp.outputs.timestamp }}
